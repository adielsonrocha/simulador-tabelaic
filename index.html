<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relat√≥rio de Performance Colaborativo</title>
    <!-- Carregando o Tailwind CSS para estilos r√°pidos e modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carregando a fonte Poppins para um visual mais elegante -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Biblioteca para gerar gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Aplicando a fonte Poppins como padr√£o */
        body {
            font-family: 'Poppins', sans-serif;
        }
        .hidden { display: none; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 50; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; }
        .bar-container { height: 12px; width: 100%; background-color: #f3f4f6; border-radius: 9999px; overflow: hidden; position: relative; }
        .bar { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; }
        .meta-line { position: absolute; height: 100%; width: 2px; background-image: linear-gradient(to bottom, #9ca3af 40%, transparent 20%); background-size: 1px 4px; top: 0; }
        .score-card-animate { animation: zoomIn 0.5s ease-out forwards; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Card Principal da Aplica√ß√£o -->
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-6 md:p-8 m-4">
        
        <!-- SE√á√ÉO DE SELE√á√ÉO INICIAL (Vis√≠vel no in√≠cio) -->
        <div id="home-section">
            <header class="mb-8 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Gerador de Relat√≥rio de Performance</h1>
                <p class="text-gray-500 mt-2">Selecione a √°rea para preencher ou visualizar os indicadores.</p>
            </header>
            <div id="leadership-selection" class="space-y-6">
                <!-- Hierarquia ser√° gerada aqui -->
            </div>
        </div>

        <!-- SE√á√ÉO DO FORMUL√ÅRIO (Oculta no in√≠cio) -->
        <div id="form-section" class="hidden">
            <header class="mb-6 flex justify-between items-start">
                <div>
                    <h1 id="form-title" class="text-2xl md:text-3xl font-bold text-gray-800"></h1>
                    <p class="text-gray-500">Preencha, adicione ou remova indicadores para gerar o relat√≥rio.</p>
                </div>
                <div class="flex gap-2">
                    <button id="back-to-home-btn" class="bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 transition-colors">‚Üê Voltar</button>
                    <button id="add-d-btn" class="bg-blue-100 text-blue-700 text-sm font-semibold py-2 px-3 rounded-lg hover:bg-blue-200 transition-colors">+ Diretriz</button>
                    <button id="add-a-btn" class="bg-purple-100 text-purple-700 text-sm font-semibold py-2 px-3 rounded-lg hover:bg-purple-200 transition-colors"> + Acompanhamento</button>
                </div>
            </header>
            
            <div class="mb-6 max-w-xs">
                <label for="reference-month" class="block mb-1 text-sm font-medium text-gray-700">M√™s de Refer√™ncia</label>
                <input type="text" id="reference-month" class="p-2 w-full border border-gray-300 bg-white rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-800">
            </div>

            <form id="indicators-form" class="space-y-4">
                <!-- Inputs ser√£o gerados aqui pelo JavaScript -->
            </form>
            <div class="mt-8 flex justify-between items-center">
                <footer class="text-xs text-gray-400">
                    adielson.rocha@equatorialenergia.com.br
                </footer>
                <div class="flex gap-2">
                    <button id="simulate-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors">
                        Simular Nota na Tabela
                    </button>
                     <button id="save-history-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                        Salvar no Hist√≥rico
                    </button>
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO DOS RESULTADOS (Oculta no in√≠cio) -->
        <div id="results-section-wrapper" class="hidden">
            <div id="results-section" class="bg-white p-8">
                <header class="mb-6 flex justify-between items-center">
                    <div>
                        <h1 id="results-title" class="text-2xl md:text-3xl font-bold text-gray-800">Resultados de Performance</h1>
                        <p class="text-gray-500">O&M Metropolitana - <span id="results-month">Maio</span></p>
                    </div>
                    <button id="view-toggle-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg id="table-view-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <svg id="dashboard-view-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                        <span id="view-toggle-text">Vis√£o em Cards</span>
                    </button>
                </header>
                
                <div id="final-scores-container" class="grid grid-cols-2 gap-4 mb-4"></div>
                <div id="table-container" class="overflow-x-auto"></div>
                <div id="dashboard-container" class="mt-6 hidden"></div>
                <div id="history-container" class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Hist√≥rico de Performance</h2>
                    <canvas id="history-chart"></canvas>
                </div>
            </div>
            <div class="mt-8 flex justify-between items-center">
                 <footer class="text-center text-sm text-gray-500">
                    <span class="mr-4"><span class="text-xl">üü¢</span> Nota >= 10</span>
                    <span class="mr-4"><span class="text-xl">üü°</span> 8 <= Nota < 10</span>
                    <span><span class="text-xl">üî¥</span> Nota < 8</span>
                </footer>
                <div>
                    <button id="export-csv-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition-colors mr-2">Exportar CSV</button>
                    <button id="back-to-form-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition-colors">‚Üê Voltar e Editar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais de Confirma√ß√£o -->
    <div id="confirm-delete-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800">Confirmar Remo√ß√£o</h3>
            <p class="text-gray-600 my-4">Voc√™ tem certeza que deseja remover este indicador? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-end gap-4">
                <button data-action="cancel" class="modal-close-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Remover</button>
            </div>
        </div>
    </div>
    <div id="confirm-history-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800">Salvar no Hist√≥rico</h3>
            <p class="text-gray-600 my-4">Voc√™ confirma o salvamento dos dados deste m√™s no hist√≥rico? Se j√° existir um registro para este m√™s, ele ser√° sobrescrito.</p>
            <div class="flex justify-end gap-4">
                <button data-action="cancel" class="modal-close-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-save-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- DADOS BASE ---
        const leaderships = [
            { id: 'gerencia_om_metro', name: 'Ger√™ncia de Obras e Manuten√ß√£o | Metropolitana', level: 1 },
            { id: 'exec_obras_rd_metro', name: 'Executiva de Obras RD | Metropolitana', level: 2 },
            { id: 'exec_manut_at_metro', name: 'Executiva de Manuten√ß√£o AT | Metropolitana', level: 2 },
            { id: 'exec_manut_rd_metro', name: 'Executiva de Manuten√ß√£o RD | Metropolitana', level: 2 },
            { id: 'lider_om_teresina', name: 'Lideran√ßa de Obras e Manuten√ß√£o | Teresina', level: 3 },
            { id: 'lider_om_campo_maior', name: 'Lideran√ßa de Obras e Manuten√ß√£o | Campo Maior', level: 3 },
        ];
        
        const defaultIndicatorsData = {
            gerencia_om_metro: [
                { id: 'qualidade_tecnica', nome: "√çndice de Qualidade T√©cnica", tipo: 'D', peso: "40%", metaMes: 10.00, realMes: 8.25, notaMes: 8.25, metaAcumulado: 10.00, realAcumulado: 11.88, notaAcumulada: 11.88, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.917l9 3 9-3a12.02 12.02 0 00-5.382-11.957z" /></svg>', fixedMeta: 10 },
                { id: 'dec_regulatoria', nome: "DEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "25%", metaMes: 1.18, realMes: 1.23, notaMes: 7.00, metaAcumulado: 8.38, realAcumulado: 7.24, notaAcumulada: 15.00, goal: 'down', icon: '' },
                { id: 'fec_regulatoria', nome: "FEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "30%", metaMes: 0.65, realMes: 0.55, notaMes: 15.00, metaAcumulado: 3.91, realAcumulado: 2.42, notaAcumulada: 15.00, goal: 'down', icon: '' },
                { id: 'penalidades', nome: "Penalidades DIC/FIC/DMIC", tipo: 'A', peso: "25%", metaMes: 402, realMes: 729, notaMes: 0.00, metaAcumulado: 6225, realAcumulado: 5802, notaAcumulada: 2.50, goal: 'down', icon: '' },
                { id: 'aderencia_limites', nome: "Ader√™ncia a Limites de Continuidade", tipo: 'A', peso: "20%", metaMes: 10.00, realMes: 14.00, notaMes: 10.00, metaAcumulado: 11.00, realAcumulado: 14.00, notaAcumulada: 15.00, goal: 'up', icon: '' },
                { id: 'cobertura_estoque', nome: "Cobertura de Estoque Parceiros", tipo: 'D', peso: "10%", metaMes: 1.3, realMes: 2.1, notaMes: 7.12, metaAcumulado: 1.3, realAcumulado: 2.1, notaAcumulada: 7.12, syncAcumulado: true, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4-8-4m16 0v10l-8 4-8-4V7" /></svg>' },
                { id: 'gastos_gerenciaveis', nome: "Gastos Gerenci√°veis", tipo: 'D', peso: "10%", metaMes: 3920, realMes: 2735, notaMes: 15.00, metaAcumulado: 20300, realAcumulado: 15179, notaAcumulada: 15.00, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>' },
                { id: 'aderencia_ligacoes', nome: "Ader√™ncia do Plano de Liga√ß√µes", tipo: 'D', peso: "20%", metaMes: 10.00, realMes: 7.36, notaMes: 7.36, metaAcumulado: 10.00, realAcumulado: 7.35, notaAcumulada: 7.35, syncAcumulado: true, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>', fixedMeta: 10 },
                { id: 'cumprimento_obras', nome: "√çndice de Cumprimento de Obras", tipo: 'D', peso: "20%", metaMes: 10.00, realMes: 6.90, notaMes: 6.90, metaAcumulado: 10.00, realAcumulado: 6.90, notaAcumulada: 6.90, syncAcumulado: true, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
                { id: 'cumprimento_torre_plpt', nome: "Cumprimento Torre de Investimentos PLPT", tipo: 'A', peso: "50%", metaMes: 4.00, realMes: 4.00, notaMes: 4.00, metaAcumulado: 4.00, realAcumulado: 4.00, notaAcumulada: 4.00, syncAcumulado: true, goal: 'up', icon: '', fixedMeta: 10 },
                { id: 'cumprimento_torre_elegivel', nome: "Cumprimento Torre de Investimentos Eleg√≠vel", tipo: 'A', peso: "50%", metaMes: 10.00, realMes: 9.80, notaMes: 9.80, metaAcumulado: 10.00, realAcumulado: 9.80, notaAcumulada: 9.80, syncAcumulado: true, goal: 'up', icon: '', fixedMeta: 10 },
            ],
            exec_obras_rd_metro: [
                { id: 'nivel_servico_ligacao', nome: "N√≠vel Servi√ßo Liga√ß√£o Nova Grupo A", tipo: 'D', peso: "15%", metaMes: 10.00, realMes: 0, notaMes: 0, metaAcumulado: 10.00, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>' },
                { id: 'avanco_torre_gambiarra', nome: "Avan√ßo F√≠sico da Torre - Gambiarra", tipo: 'D', peso: "15%", metaMes: 10.00, realMes: 0, notaMes: 0, metaAcumulado: 10.00, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>' },
                { id: 'cobertura_estoque_obras', nome: "Cobertura de Estoque Parceiros", tipo: 'D', peso: "15%", metaMes: 1.0, realMes: 0, notaMes: 0, metaAcumulado: 1.0, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4-8-4m16 0v10l-8 4-8-4V7" /></svg>' },
                { id: 'aderencia_plano_ligacoes', nome: "Ader√™ncia do Plano de Liga√ß√µes c/ Obras", tipo: 'D', peso: "25%", metaMes: 10.00, realMes: 0, notaMes: 0, metaAcumulado: 10.00, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>', fixedMeta: 10 },
                { id: 'cumprimento_torre_invest', nome: "Cumprimento Torre de Investimentos - PLPT", tipo: 'D', peso: "30%", metaMes: 10.00, realMes: 0, notaMes: 0, metaAcumulado: 10.00, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
            ],
            exec_manut_rd_metro: [
                { id: 'eficacia_plano_manut', nome: "√çndice de Efic√°cia do Plano de Manuten√ß√£o (RD)", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>' },
                { id: 'eficiencia_circuitos', nome: "Efici√™ncia dos Circuitos RD Conclu√≠dos 100%", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'plano_manut_concluidos', nome: "Plano de Manuten√ß√£o RD - Circuitos Conclu√≠dos", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'aderencia_conjuntos', nome: "Ader√™ncia √† Limites de Conjuntos El√©tricos", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>' },
                { id: 'indice_dec_fec_at', nome: "√çndice DEC e FEC - Vis√£o Regulat√≥ria", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.917l9 3 9-3a12.02 12.02 0 00-5.382-11.957z" /></svg>' },
                { id: 'dec_visao_reg_at', nome: "DEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "40%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'fec_visao_reg_at', nome: "FEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "60%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'gastos_manut_rd', nome: "Gastos Gerenci√°veis - Exec Manut RD", tipo: 'D', peso: "20%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>' },
                { id: 'cumprimento_torre_manut', nome: "Cumprimento Torre Investimentos Eleg√≠vel", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
            ],
            exec_manut_at_metro: [
                { id: 'anomalias_medicao', nome: "Anomalias Medi√ß√£o Operacional + Fronteira", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>' },
                { id: 'indice_dec_fec_at_2', nome: "√çndice DEC e FEC - Vis√£o Regulat√≥ria", tipo: 'D', peso: "30%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.917l9 3 9-3a12.02 12.02 0 00-5.382-11.957z" /></svg>' },
                { id: 'dec_visao_reg_at_2', nome: "DEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "40%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'fec_visao_reg_at_2', nome: "FEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "60%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'cumprimento_torre_at', nome: "Cumprimento Torre Investimentos - Eleg√≠vel", tipo: 'D', peso: "20%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
                { id: 'eficacia_plano_manut_at', nome: "Efic√°cia do Plano de Manuten√ß√£o AT", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>' },
            ],
            lider_om_teresina: [
                { id: 'eficacia_plano_manut_ter', nome: "√çndice de Efic√°cia do Plano de Manuten√ß√£o (RD)", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>' },
                { id: 'eficiencia_circuitos_ter', nome: "Efici√™ncia dos Circuitos RD Conclu√≠dos 100%", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'plano_manut_concluidos_ter', nome: "Plano de Manuten√ß√£o RD - Circuitos Conclu√≠dos", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'indice_dec_fec_ter', nome: "√çndice DEC e FEC - Vis√£o Regulat√≥ria", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.917l9 3 9-3a12.02 12.02 0 00-5.382-11.957z" /></svg>' },
                { id: 'dec_visao_reg_ter', nome: "DEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'fec_visao_reg_ter', nome: "FEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'taxa_avaria_transf_ter', nome: "Taxa de Avaria de Transformadores", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>' },
                { id: 'cumprimento_torre_obras_man_ter', nome: "Cumprimento Torre Investimentos Eleg√≠vel", tipo: 'D', peso: "20%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
                { id: 'tratamento_demanda_clientes_ter', nome: "Tratamento de Demanda de Clientes", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>' },
            ],
            lider_om_campo_maior: [
                { id: 'eficacia_plano_manut_cm', nome: "√çndice de Efic√°cia do Plano de Manuten√ß√£o (RD)", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>' },
                { id: 'eficiencia_circuitos_cm', nome: "Efici√™ncia dos Circuitos RD Conclu√≠dos 100%", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'plano_manut_concluidos_cm', nome: "Plano de Manuten√ß√£o RD - Circuitos Conclu√≠dos", tipo: 'A', peso: "50%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '' },
                { id: 'indice_dec_fec_cm', nome: "√çndice DEC e FEC - Vis√£o Regulat√≥ria", tipo: 'D', peso: "25%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.917l9 3 9-3a12.02 12.02 0 00-5.382-11.957z" /></svg>' },
                { id: 'dec_visao_reg_cm', nome: "DEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "40%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'fec_visao_reg_cm', nome: "FEC Vis√£o Regulat√≥ria", tipo: 'A', peso: "60%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '' },
                { id: 'taxa_avaria_transf_cm', nome: "Taxa de Avaria de Transformadores", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'down', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>' },
                { id: 'cumprimento_torre_obras_man_cm', nome: "Cumprimento Torre Investimentos Eleg√≠vel", tipo: 'D', peso: "20%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>', fixedMeta: 10 },
                { id: 'tratamento_demanda_clientes_cm', nome: "Tratamento de Demanda de Clientes", tipo: 'D', peso: "15%", metaMes: 10, realMes: 0, notaMes: 0, metaAcumulado: 10, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>' },
            ]
        };
        let indicadores = [];
        let historyChart = null;
        let currentLeadershipId = null;

        // --- ELEMENTOS DO HTML ---
        const homeSection = document.getElementById('home-section');
        const leadershipSelection = document.getElementById('leadership-selection');
        const formSection = document.getElementById('form-section');
        const formTitle = document.getElementById('form-title');
        const resultsSectionWrapper = document.getElementById('results-section-wrapper');
        const resultsSection = document.getElementById('results-section');
        const resultsTitle = document.getElementById('results-title');
        const indicatorsForm = document.getElementById('indicators-form');
        const tableContainer = document.getElementById('table-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const finalScoresContainer = document.getElementById('final-scores-container');
        const simulateBtn = document.getElementById('simulate-btn');
        const saveHistoryBtn = document.getElementById('save-history-btn');
        const backBtn = document.getElementById('back-to-form-btn');
        const monthInput = document.getElementById('reference-month');
        const resultsMonthSpan = document.getElementById('results-month');
        const addDBtn = document.getElementById('add-d-btn');
        const addABtn = document.getElementById('add-a-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const confirmHistoryModal = document.getElementById('confirm-history-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');
        const viewToggleBtn = document.getElementById('view-toggle-btn');
        const viewToggleText = document.getElementById('view-toggle-text');
        const tableViewIcon = document.getElementById('table-view-icon');
        const dashboardViewIcon = document.getElementById('dashboard-view-icon');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        let indicadorToDelete = null;

        // --- FUN√á√ïES ---

        function saveData() {
            if (!currentLeadershipId) return;
            const dataToSave = {
                month: monthInput.value,
                indicators: indicadores
            };
            localStorage.setItem(`performanceReportData_${currentLeadershipId}`, JSON.stringify(dataToSave));
        }

        function loadData() {
            if (!currentLeadershipId) return;
            const savedData = localStorage.getItem(`performanceReportData_${currentLeadershipId}`);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                indicadores = parsedData.indicators;
                monthInput.value = parsedData.month;
            } else {
                indicadores = JSON.parse(JSON.stringify(defaultIndicatorsData[currentLeadershipId] || defaultIndicatorsData.gerencia_om_metro)); // Deep copy
                const today = new Date();
                today.setMonth(today.getMonth() - 1);
                const prevMonthName = today.toLocaleDateString('pt-BR', { month: 'long' });
                monthInput.value = prevMonthName.charAt(0).toUpperCase() + prevMonthName.slice(1);
            }
        }

        function sortIndicators(data) {
            const groups = [];
            let currentGroup = [];
            data.forEach(indicador => {
                if (indicador.tipo === 'D' && currentGroup.length > 0) {
                    groups.push(currentGroup);
                    currentGroup = [];
                }
                currentGroup.push(indicador);
            });
            if (currentGroup.length > 0) groups.push(currentGroup);
            groups.sort((a, b) => parseFloat(a[0].peso) - parseFloat(b[0].peso));
            return groups.flat();
        }

        function getStatus(nota) {
            if (nota >= 10) return { class: 'bg-green-100 text-green-800' };
            if (nota >= 8) return { class: 'bg-yellow-100 text-yellow-800' };
            return { class: 'bg-red-100 text-red-800' };
        }
        
        function getRealValueColor(meta, real, goal) {
            if (real === meta) return 'text-gray-600';
            if (goal === 'down') return real < meta ? 'text-green-600' : 'text-red-600';
            return real > meta ? 'text-green-600' : 'text-red-600';
        }

        function getBarColor(nota) {
            if (nota >= 10) return 'bg-green-400';
            if (nota >= 8) return 'bg-yellow-400';
            return 'bg-red-400';
        }

        function formatNumber(value, indicatorId) {
            if (indicatorId && (indicatorId.includes('gastos') || indicatorId.includes('penalidades'))) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return value.toFixed(2).replace('.', ',');
        }

        function calculateScores() {
            for (let i = 0; i < indicadores.length; i++) {
                if (indicadores[i].tipo === 'D') {
                    let weightedSumMes = 0;
                    let weightedSumAcumulado = 0;
                    let hasChildren = false;
                    let j = i + 1;
                    while (j < indicadores.length && indicadores[j].tipo === 'A') {
                        hasChildren = true;
                        const child = indicadores[j];
                        const weight = parseFloat(child.peso) / 100;
                        weightedSumMes += child.notaMes * weight;
                        weightedSumAcumulado += child.notaAcumulada * weight;
                        j++;
                    }
                    if (hasChildren) {
                        indicadores[i].notaMes = weightedSumMes;
                        indicadores[i].notaAcumulada = weightedSumAcumulado;
                    }
                }
            }

            let finalNotaMes = 0;
            let finalNotaAcumulada = 0;
            let totalWeight = 0;
            indicadores.forEach(indicador => {
                if (indicador.tipo === 'D') {
                    const weight = parseFloat(indicador.peso) / 100;
                    totalWeight += weight;
                    finalNotaMes += indicador.notaMes * weight;
                    finalNotaAcumulada += indicador.notaAcumulada * weight;
                }
            });
            const finalMes = totalWeight > 0 ? finalNotaMes / totalWeight : 0;
            const finalAcumulado = totalWeight > 0 ? finalNotaAcumulada / totalWeight : 0;
            return { 
                finalNotaMes: Math.max(0, Math.min(15, finalMes)), 
                finalNotaAcumulada: Math.max(0, Math.min(15, finalAcumulado)) 
            };
        }

        function renderFinalScores(scores) {
            const monthName = monthInput.value || "M√™s";
            const statusMes = getStatus(scores.finalNotaMes);
            const statusAcumulado = getStatus(scores.finalNotaAcumulada);
            finalScoresContainer.innerHTML = `
                <div class="p-4 rounded-lg text-center ${statusMes.class} score-card-animate">
                    <h3 class="text-sm font-semibold text-gray-600">${monthName} - Nota Final</h3>
                    <p class="text-3xl font-bold ${statusMes.class.replace('bg-', 'text-').replace('-100', '-600')}">${scores.finalNotaMes.toFixed(2).replace('.', ',')}</p>
                </div>
                <div class="p-4 rounded-lg text-center ${statusAcumulado.class} score-card-animate" style="animation-delay: 0.1s;">
                    <h3 class="text-sm font-semibold text-gray-600">Acumulado - Nota Final</h3>
                    <p class="text-3xl font-bold ${statusAcumulado.class.replace('bg-', 'text-').replace('-100', '-600')}">${scores.finalNotaAcumulada.toFixed(2).replace('.', ',')}</p>
                </div>
            `;
        }

        function renderForm() {
            indicatorsForm.innerHTML = '';
            indicadores.forEach(indicador => {
                const isAcompanhamento = indicador.tipo === 'A';
                const hasChildren = indicador.tipo === 'D' && (indicadores[indicadores.indexOf(indicador) + 1]?.tipo === 'A');
                const syncAcumulado = indicador.syncAcumulado;
                const isMetaLocked = indicador.fixedMeta !== undefined;
                const metaValue = isMetaLocked ? indicador.fixedMeta : indicador.metaMes;
                const labelStyle = isAcompanhamento ? 'italic' : 'font-semibold';
                const arrow = indicador.goal === 'up' ? '<span class="text-gray-500 font-bold">‚Üë</span>' : '<span class="text-gray-500 font-bold">‚Üì</span>';

                const formRow = `
                    <div class="p-4 border rounded-lg ${isAcompanhamento ? 'bg-gray-50' : 'bg-white'} relative">
                        <button type="button" data-id="${indicador.id}" class="remove-indicator-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                        <label class="block text-md ${labelStyle} text-gray-800 mb-4 flex items-center gap-3">
                            ${indicador.icon || ''}
                            <span class="${isAcompanhamento ? 'pl-6' : ''}">${indicador.nome}</span>
                            ${arrow}
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="p-3 border rounded-md">
                                <h4 class="font-semibold text-center mb-2">M√™s</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label for="${indicador.id}-metaMes" class="block text-xs font-medium text-gray-500">Meta</label><input type="number" step="0.01" id="${indicador.id}-metaMes" value="${metaValue}" ${isMetaLocked ? 'disabled' : ''} class="mt-1 p-2 w-full border-gray-300 rounded-md disabled:bg-gray-200"></div>
                                    <div><label for="${indicador.id}-realMes" class="block text-xs font-medium text-gray-500">Real</label><input type="number" step="0.01" id="${indicador.id}-realMes" value="${indicador.realMes}" class="mt-1 p-2 w-full border-gray-300 rounded-md"></div>
                                    <div><label for="${indicador.id}-notaMes" class="block text-xs font-medium text-gray-500">Nota</label><input type="number" step="0.01" min="0" max="15" id="${indicador.id}-notaMes" value="${indicador.notaMes}" ${hasChildren ? 'disabled' : ''} class="mt-1 p-2 w-full border-gray-300 rounded-md font-bold disabled:bg-gray-200"></div>
                                </div>
                            </div>
                            <div class="p-3 border rounded-md">
                                <h4 class="font-semibold text-center mb-2">Acumulado</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <div><label for="${indicador.id}-metaAcumulado" class="block text-xs font-medium text-gray-500">Meta</label><input type="number" step="0.01" id="${indicador.id}-metaAcumulado" value="${metaValue}" ${isMetaLocked || syncAcumulado ? 'disabled' : ''} class="mt-1 p-2 w-full border-gray-300 rounded-md disabled:bg-gray-200"></div>
                                    <div><label for="${indicador.id}-realAcumulado" class="block text-xs font-medium text-gray-500">Real</label><input type="number" step="0.01" id="${indicador.id}-realAcumulado" value="${indicador.realAcumulado}" ${syncAcumulado ? 'disabled' : ''} class="mt-1 p-2 w-full border-gray-300 rounded-md disabled:bg-gray-200"></div>
                                    <div><label for="${indicador.id}-notaAcumulada" class="block text-xs font-medium text-gray-500">Nota</label><input type="number" step="0.01" min="0" max="15" id="${indicador.id}-notaAcumulada" value="${indicador.notaAcumulada}" ${hasChildren || syncAcumulado ? 'disabled' : ''} class="mt-1 p-2 w-full border-gray-300 rounded-md font-bold disabled:bg-gray-200"></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                indicatorsForm.innerHTML += formRow;
            });
        }

        function renderTable() {
            const monthName = monthInput.value || "M√™s";
            let tableHTML = `
                <table class="min-w-full text-center table-fixed">
                    <thead class="bg-gray-700 text-white">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 38%;">Indicador</th>
                            <th class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 12%;">Gr√°fico (Nota Acum.)</th>
                            <th class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 5%;">Tipo</th>
                            <th class="px-2 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 5%;">Peso</th>
                            <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 12.5%;">${monthName}</th>
                            <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 10%;">Nota</th>
                            <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-r border-gray-600" style="width: 12.5%;">Acumulado</th>
                            <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider">Nota</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">`;

            indicadores.forEach((dado) => {
                const statusMes = getStatus(dado.notaMes);
                const statusAcumulado = getStatus(dado.notaAcumulada);
                const colorMes = getRealValueColor(dado.metaMes, dado.realMes, dado.goal);
                const colorAcumulado = getRealValueColor(dado.metaAcumulado, dado.realAcumulado, dado.goal);
                const isAcompanhamento = dado.tipo === 'A';
                const rowStyle = isAcompanhamento ? 'bg-gray-50' : 'bg-white';
                const textStyle = isAcompanhamento ? 'italic text-xs' : 'font-semibold text-sm';
                const paddingStyle = isAcompanhamento ? 'pl-10' : 'pl-6';
                const arrow = dado.goal === 'up' ? '<span class="text-gray-500 font-bold ml-2">‚Üë</span>' : '<span class="text-gray-500 font-bold ml-2">‚Üì</span>';

                const notaPercent = (dado.notaAcumulada / 15) * 100;
                const metaLinePercent = (10 / 15) * 100;
                const barColor = getBarColor(dado.notaAcumulada);

                const graphHTML = `
                    <div class="bar-container my-1">
                        <div class="bar ${barColor}" style="width: ${notaPercent}%;"></div>
                        <div class="meta-line" style="left: ${metaLinePercent}%;"></div>
                    </div>
                `;

                tableHTML += `
                    <tr class="${rowStyle} hover:bg-gray-100 transition-colors duration-150">
                        <td rowspan="2" class="px-6 py-4 text-left align-middle text-gray-800 border-b ${textStyle}">
                            <div class="flex items-center gap-3 ${paddingStyle}">
                                ${dado.icon || ''}
                                <span>${dado.nome}</span>
                                ${arrow}
                            </div>
                        </td>
                        <td rowspan="2" class="px-4 py-4 align-middle border-b">${graphHTML}</td>
                        <td rowspan="2" class="px-2 py-4 align-middle text-sm text-gray-500 font-mono border-b">${dado.tipo}</td>
                        <td rowspan="2" class="px-2 py-4 align-middle text-sm text-gray-500 border-b">${dado.peso}</td>
                        <td class="px-3 py-2 text-sm text-gray-600"><div class="flex justify-between items-center"><span class="font-mono text-gray-500">M</span><span>${formatNumber(dado.metaMes, dado.id)}</span></div></td>
                        <td rowspan="2" class="px-3 py-4 align-middle border-b">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${statusMes.class}">${dado.notaMes.toFixed(2).replace('.', ',')}</span>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-600 border-l border-gray-200"><div class="flex justify-between items-center"><span class="font-mono text-gray-500">M</span><span>${formatNumber(dado.metaAcumulado, dado.id)}</span></div></td>
                        <td rowspan="2" class="px-3 py-4 align-middle border-b">
                             <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${statusAcumulado.class}">${dado.notaAcumulada.toFixed(2).replace('.', ',')}</span>
                        </td>
                    </tr>
                     <tr class="${rowStyle} hover:bg-gray-100 transition-colors duration-150 border-b">
                        <td class="px-3 pt-1 pb-2 text-sm font-semibold ${colorMes}"><div class="flex justify-between items-center"><span class="font-mono ${colorMes}">R</span><span>${formatNumber(dado.realMes, dado.id)}</span></div></td>
                        <td class="px-3 pt-1 pb-2 text-sm font-semibold ${colorAcumulado} border-l border-gray-200"><div class="flex justify-between items-center"><span class="font-mono ${colorAcumulado}">R</span><span>${formatNumber(dado.realAcumulado, dado.id)}</span></div></td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            tableContainer.innerHTML = tableHTML;
        }
        
        function renderDashboard() {
            const monthName = monthInput.value || "M√™s";
            let dashboardHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';

            for (let i = 0; i < indicadores.length; i++) {
                const dado = indicadores[i];
                if (dado.tipo === 'D') {
                    const statusMes = getStatus(dado.notaMes);
                    const statusAcumulado = getStatus(dado.notaAcumulada);
                    const arrow = dado.goal === 'up' ? '<span class="text-gray-500 font-bold ml-2">‚Üë</span>' : '<span class="text-gray-500 font-bold ml-2">‚Üì</span>';
                    
                    let childrenHTML = '';
                    let j = i + 1;
                    while (j < indicadores.length && indicadores[j].tipo === 'A') {
                        const child = indicadores[j];
                        const childStatusMes = getStatus(child.notaMes);
                        const childStatusAcumulado = getStatus(child.notaAcumulada);
                        const childArrow = child.goal === 'up' ? '<span class="text-gray-500 font-bold ml-2">‚Üë</span>' : '<span class="text-gray-500 font-bold ml-2">‚Üì</span>';
                        
                        childrenHTML += `
                            <div class="mt-2 pt-2 border-t">
                                <h4 class="text-xs italic text-gray-600 flex items-center">${child.nome} ${childArrow}</h4>
                                <div class="flex justify-between text-xs mt-1">
                                    <span>M√™s: <span class="font-bold px-2 py-0.5 rounded-full ${childStatusMes.class}">${formatNumber(child.notaMes)}</span></span>
                                    <span>Acum.: <span class="font-bold px-2 py-0.5 rounded-full ${childStatusAcumulado.class}">${formatNumber(child.notaAcumulada)}</span></span>
                                </div>
                            </div>
                        `;
                        j++;
                    }
                    
                    dashboardHTML += `
                        <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-2 border-t-4 ${getBarColor(dado.notaAcumulada).replace('bg-','border-')}">
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-gray-800 flex items-center gap-2">${dado.icon} ${dado.nome} ${arrow}</h3>
                                <span class="text-sm font-bold text-gray-500">${dado.peso}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div class="text-center">
                                    <p class="text-xs text-gray-500">${monthName}</p>
                                    <p class="text-lg font-bold px-2 py-1 rounded-full ${statusMes.class}">${formatNumber(dado.notaMes)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-500">Acumulado</p>
                                    <p class="text-lg font-bold px-2 py-1 rounded-full ${statusAcumulado.class}">${formatNumber(dado.notaAcumulada)}</p>
                                </div>
                            </div>
                            ${childrenHTML ? `<div class="mt-2">${childrenHTML}</div>` : ''}
                        </div>
                    `;
                    i = j - 1;
                }
            }
            dashboardHTML += '</div>';
            dashboardContainer.innerHTML = dashboardHTML;
        }

        function renderHistoryChart() {
            const historyData = JSON.parse(localStorage.getItem(`performanceHistory_${currentLeadershipId}`)) || [];
            const ctx = document.getElementById('history-chart').getContext('2d');
            const gridColor = 'rgba(0, 0, 0, 0.1)';
            const textColor = '#1f2937';
            
            if(historyChart) {
                historyChart.destroy();
            }

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyData.map(d => d.month),
                    datasets: [{
                        label: 'Nota Final M√™s',
                        data: historyData.map(d => d.scoreMes),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        tension: 0.1
                    }, {
                        label: 'Nota Final Acumulada',
                        data: historyData.map(d => d.scoreAcumulado),
                        borderColor: 'rgb(234, 179, 8)',
                        backgroundColor: 'rgba(234, 179, 8, 0.5)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuad'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 15,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function renderHomeScreen() {
            leadershipSelection.innerHTML = '';
            const levels = [...new Set(leaderships.map(l => l.level))].sort((a,b) => a-b);
            levels.forEach(level => {
                const levelContainer = document.createElement('div');
                if (level > 1) {
                    levelContainer.classList.add('pt-4', 'mt-4', 'border-t');
                }
                const levelLeaderships = leaderships.filter(l => l.level === level);
                const gridCols = level === 1 ? 'lg:grid-cols-1' : (level === 2 ? 'lg:grid-cols-3' : 'lg:grid-cols-2');
                levelContainer.className += ` grid grid-cols-1 md:grid-cols-2 ${gridCols} gap-4`;
                
                levelLeaderships.forEach(lead => {
                    const card = `
                        <button data-id="${lead.id}" class="leadership-card text-left p-6 bg-gray-50 hover:bg-blue-100 border border-gray-200 rounded-lg transition-colors">
                            <h3 class="font-bold text-lg text-gray-800">${lead.name}</h3>
                        </button>
                    `;
                    levelContainer.innerHTML += card;
                });
                leadershipSelection.appendChild(levelContainer);
            });
        }

        // --- EVENTOS ---
        indicatorsForm.addEventListener('input', (event) => {
            const inputElement = event.target;
            const targetId = inputElement.id;
            
            if (targetId.includes('notaMes') || targetId.includes('notaAcumulada')) {
                if (parseFloat(inputElement.value) > 15) inputElement.value = 15;
                if (parseFloat(inputElement.value) < 0) inputElement.value = 0;
            }

            const [indicatorId, field] = targetId.split('-');
            const indicador = indicadores.find(ind => ind.id === indicatorId);
            if (!indicador) return;

            if (indicador.syncAcumulado && field.endsWith('Mes')) {
                const syncFields = ['metaMes', 'realMes', 'notaMes'];
                syncFields.forEach(syncField => {
                    const sourceEl = document.getElementById(`${indicador.id}-${syncField}`);
                    const destEl = document.getElementById(`${indicador.id}-${syncField.replace('Mes', 'Acumulada')}`);
                    if (sourceEl && destEl) destEl.value = sourceEl.value;
                });
            }

            if (indicador.tipo === 'A' && (field === 'notaMes' || field === 'notaAcumulada')) {
                let parentIndex = -1;
                for (let i = indicadores.indexOf(indicador) - 1; i >= 0; i--) {
                    if (indicadores[i].tipo === 'D') {
                        parentIndex = i;
                        break;
                    }
                }
                if (parentIndex !== -1) {
                    const parent = indicadores[parentIndex];
                    let weightedSum = 0;
                    let j = parentIndex + 1;
                    while (j < indicadores.length && indicadores[j].tipo === 'A') {
                        const child = indicadores[j];
                        const noteInput = document.getElementById(`${child.id}-${field}`);
                        const weight = parseFloat(child.peso) / 100;
                        weightedSum += (parseFloat(noteInput.value) || 0) * weight;
                        j++;
                    }
                    const parentNoteInput = document.getElementById(`${parent.id}-${field}`);
                    parentNoteInput.value = Math.max(0, Math.min(15, weightedSum)).toFixed(2);
                }
            }
        });

        function updateAndSave() {
            indicadores.forEach(indicador => {
                indicador.metaMes = parseFloat(document.getElementById(`${indicador.id}-metaMes`).value) || 0;
                indicador.realMes = parseFloat(document.getElementById(`${indicador.id}-realMes`).value) || 0;
                indicador.notaMes = Math.max(0, Math.min(15, parseFloat(document.getElementById(`${indicador.id}-notaMes`).value) || 0));
                indicador.metaAcumulado = parseFloat(document.getElementById(`${indicador.id}-metaAcumulado`).value) || 0;
                indicador.realAcumulado = parseFloat(document.getElementById(`${indicador.id}-realAcumulado`).value) || 0;
                indicador.notaAcumulada = Math.max(0, Math.min(15, parseFloat(document.getElementById(`${indicador.id}-notaAcumulada`).value) || 0));
            });
            saveData();
        }

        function showReport() {
            resultsMonthSpan.textContent = monthInput.value || "M√™s";
            const finalScores = calculateScores();
            renderFinalScores(finalScores);
            indicadores = sortIndicators(indicadores);
            renderTable(); 
            renderDashboard();
            renderHistoryChart();
            formSection.classList.add('hidden');
            resultsSectionWrapper.classList.remove('hidden');
            return finalScores;
        }

        simulateBtn.addEventListener('click', () => {
            updateAndSave();
            showReport();
        });

        saveHistoryBtn.addEventListener('click', () => {
            confirmHistoryModal.classList.remove('hidden');
        });

        confirmSaveBtn.addEventListener('click', () => {
            updateAndSave();
            const finalScores = showReport();
            
            let history = JSON.parse(localStorage.getItem(`performanceHistory_${currentLeadershipId}`)) || [];
            const month = monthInput.value || "Sem M√™s";
            const existingIndex = history.findIndex(item => item.month === month);
            const newEntry = { month: month, scoreMes: finalScores.finalNotaMes, scoreAcumulado: finalScores.finalNotaAcumulada };
            
            if (existingIndex > -1) {
                history[existingIndex] = newEntry;
            } else {
                history.push(newEntry);
            }
            localStorage.setItem(`performanceHistory_${currentLeadershipId}`, JSON.stringify(history));
            
            renderHistoryChart();
            confirmHistoryModal.classList.add('hidden');
        });

        backBtn.addEventListener('click', () => {
            updateAndSave();
            renderForm();
            resultsSectionWrapper.classList.add('hidden');
            formSection.classList.remove('hidden');
        });

        addDBtn.addEventListener('click', () => {
            const nome = prompt("Nome do novo indicador Diretriz:");
            if (!nome) return;
            const peso = prompt("Peso do indicador (ex: 20%):");
            const newId = `custom_${Date.now()}`;
            indicadores.push({
                id: newId, nome: nome, tipo: 'D', peso: peso || "0%", metaMes: 0, realMes: 0, notaMes: 0, metaAcumulado: 0, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>'
            });
            renderForm();
            saveData();
        });

        addABtn.addEventListener('click', () => {
            const nome = prompt("Nome do novo indicador de Acompanhamento:");
            if (!nome) return;
            const peso = prompt("Peso do indicador (ex: 50%):");
            const newId = `custom_${Date.now()}`;
            indicadores.push({
                id: newId, nome: nome, tipo: 'A', peso: peso || "0%", metaMes: 0, realMes: 0, notaMes: 0, metaAcumulado: 0, realAcumulado: 0, notaAcumulada: 0, goal: 'up', icon: ''
            });
            renderForm();
            saveData();
        });

        indicatorsForm.addEventListener('click', (e) => {
            if (e.target.closest('.remove-indicator-btn')) {
                indicadorToDelete = e.target.closest('.remove-indicator-btn').dataset.id;
                confirmDeleteModal.classList.remove('hidden');
            }
        });
        
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
                confirmHistoryModal.classList.add('hidden');
            });
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (indicadorToDelete) {
                const indexToRemove = indicadores.findIndex(ind => ind.id === indicadorToDelete);
                if (indexToRemove > -1) {
                    if (indicadores[indexToRemove].tipo === 'D') {
                        let j = indexToRemove + 1;
                        while(j < indicadores.length && indicadores[j].tipo === 'A') {
                            j++;
                        }
                        indicadores.splice(indexToRemove, j - indexToRemove);
                    } else {
                        indicadores.splice(indexToRemove, 1);
                    }
                }
                renderForm();
                saveData();
            }
            indicadorToDelete = null;
            confirmDeleteModal.classList.add('hidden');
        });

        exportCsvBtn.addEventListener('click', () => {
            const headers = ['Indicador', 'Tipo', 'Peso', 'Meta M√™s', 'Real M√™s', 'Nota M√™s', 'Meta Acumulado', 'Real Acumulado', 'Nota Acumulada'];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n";

            indicadores.forEach(d => {
                const row = [
                    d.nome, d.tipo, d.peso,
                    String(d.metaMes).replace('.',','), String(d.realMes).replace('.',','), String(d.notaMes).replace('.',','),
                    String(d.metaAcumulado).replace('.',','), String(d.realAcumulado).replace('.',','), String(d.notaAcumulada).replace('.',',')
                ];
                csvContent += row.join(";") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `relatorio_${currentLeadershipId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        viewToggleBtn.addEventListener('click', () => {
            tableContainer.classList.toggle('hidden');
            dashboardContainer.classList.toggle('hidden');
            tableViewIcon.classList.toggle('hidden');
            dashboardViewIcon.classList.toggle('hidden');
            viewToggleText.textContent = tableContainer.classList.contains('hidden') ? 'Vis√£o em Tabela' : 'Vis√£o em Cards';
        });

        leadershipSelection.addEventListener('click', (e) => {
            const card = e.target.closest('.leadership-card');
            if (card) {
                currentLeadershipId = card.dataset.id;
                const leadershipName = leaderships.find(l => l.id === currentLeadershipId).name;
                formTitle.textContent = leadershipName;
                resultsTitle.textContent = leadershipName;
                
                loadData();
                indicadores = sortIndicators(indicadores);
                renderForm();
                
                homeSection.classList.add('hidden');
                formSection.classList.remove('hidden');
            }
        });

        backToHomeBtn.addEventListener('click', () => {
            currentLeadershipId = null;
            formSection.classList.add('hidden');
            homeSection.classList.remove('hidden');
        });

        // --- INICIALIZA√á√ÉO ---
        renderHomeScreen();
    </script>
</body>
</html>
